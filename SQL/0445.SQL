/*
** DETALHE DO DESCONTO ADM NA TELA DE VENDAS, GRADE PRODUTOS
*/

SET TERM ^ ;

ALTER PROCEDURE REL_NOTAPRO (
    CODMOVIMENTO INTEGER)
RETURNS (
    CODIGO INTEGER,
    BARRA CHAR(13),
    DESCRICAO1 VARCHAR(60),
    DESCRICAO2 VARCHAR(80),
    SERIE VARCHAR(20),
    SERIE2 VARCHAR(20),
    VALOR_VENDA NUMERIC(14,3),
    ICMS_VENDA NUMERIC(14,4),
    DESCONTO NUMERIC(14,3),
    QUANTIDADE NUMERIC(14,3),
    VALOR_PAGO NUMERIC(14,3),
    VALOR_ICMS NUMERIC(14,3),
    SITTRIBU CHAR(3),
    UNIDADE CHAR(2),
    VALOR_ITEM NUMERIC(14,3),
    IPI NUMERIC(14,4),
    LINHA VARCHAR(20),
    OPERADORA VARCHAR(40),
    PLANO VARCHAR(40),
    CONTRATO VARCHAR(10),
    VOUCHER VARCHAR(10),
    TIPOATIVACAO CHAR(1),
    CLASSFISCAL VARCHAR(20),
    PESO NUMERIC(9,3),
    VALOR_IPI NUMERIC(14,3),
    DESCONTO_ADM NUMERIC(9,2))
AS
DECLARE VARIABLE ES INTEGER;
DECLARE VARIABLE XIPI CHAR(1);
DECLARE VARIABLE FATURA_CAIXAS CHAR(1);
DECLARE VARIABLE CAIXA_ITENS INTEGER;
DECLARE VARIABLE N INTEGER;
BEGIN
  /* VERIFICO SE EH COMPRA OU VENDA */
  SELECT
    ES
  FROM
    MOVIMENTOS
  WHERE
    CODIGO = :CODMOVIMENTO
  INTO
    :ES;

  IF (ES = 1) THEN
   BEGIN

     /* COMPRA */
     FOR
     SELECT
       TI.CODPRODUTO,
       PO.BARRA,
       PO.DESCRICAO,
       PO.UNIDADE,
       PO.CLASSFISCAL,
       PO.PESO,
       'N/F',
       TI.VALOR_UNITARIO,
       TI.ICMSCOMPRA,
       TI.DESCONTO,
       TI.SITTRIBU,
       TI.QUANTIDADE,
       TI.VALOR_TOTAL,
       TI.VALOR_ICMSCOMPRA
     FROM
       TEMPITENS TI
       LEFT JOIN PRODUTOS PO ON
         ( PO.CODIGO = TI.CODPRODUTO )
     WHERE
       TI.CODMOVIMENTO = :CODMOVIMENTO
     INTO
       :CODIGO,
       :BARRA,
       :DESCRICAO1,
       :UNIDADE,
       :CLASSFISCAL,
       :PESO,
       :SERIE,
       :VALOR_VENDA,
       :ICMS_VENDA,
       :DESCONTO,
       :SITTRIBU,
       :QUANTIDADE,
       :VALOR_PAGO,
       :VALOR_ICMS
     DO
     BEGIN

       IF (SERIE <> 'N/F') THEN
        BEGIN
          N = UDF_LEN(UDF_TRIM(DESCRICAO1));
          IF (N > 40) THEN
            DESCRICAO2 = UDF_COPY(DESCRICAO1, 1, 40) || ' ' || UDF_TRIM(SERIE);
          ELSE
            DESCRICAO2 = UDF_TRIM(DESCRICAO1) || ' ' || UDF_TRIM(SERIE);
        END ELSE
          DESCRICAO2 = DESCRICAO1;

       VALOR_ITEM = VALOR_VENDA - DESCONTO;
       PESO = PESO * QUANTIDADE;
       LINHA = NULL;
       OPERADORA = NULL;
       PLANO = NULL;
       CONTRATO = NULL;
       VOUCHER = NULL;
       TIPOATIVACAO = NULL;
       SUSPEND;

    END

   END ELSE
   BEGIN

     /* VERIFICO SE CORTO IPI */
     SELECT
       NA.IPI
     FROM
       NATUOPER NA
       JOIN MOVIMENTOS MO ON
         (MO.NOTA_CODNATUOPER = NA.CODIGO)
     WHERE
       MO.CODIGO = :CODMOVIMENTO
     INTO
       :XIPI;

     /* VERIFICO SE VAI FATURAR POR CAIXAS */
     SELECT
       HG.FATURA_CAIXAS
     FROM
       HISTORICOPAG HG
       JOIN MOVIMENTOS MO ON
         (MO.CODHISTORICOPAG = HG.CODIGO)
     WHERE
       MO.CODIGO = :CODMOVIMENTO
     INTO
       :FATURA_CAIXAS;

     /* VENDA */
     FOR
     SELECT
       ID.CODPRODUTO,
       ID.BARRA,
       PO.DESCRICAO,
       PO.UNIDADE,
       PO.CLASSFISCAL,
       PO.PESO,
       PO.CAIXA_ITENS,
       ID.SERIE,
       ID.SERIE2,
       ID.VALOR_VENDA,
       ID.ICMSVENDA,
       ID.DESCONTO,
       TI.SITTRIBU,
       TI.IPI,
       ID.NUMERO_FONE,
       ID.CONTRATO,
       ID.VOUCHER,
       ID.TIPOATIVACAO,
       ID.DESCONTO_ADM, 
       OP.NOME,
       PL.NOME,
       SUM(ID.QUANTIDADE),
       SUM(ID.VALOR_PAGO),
       SUM(ID.VALOR_ICMS)
     FROM
       INDIVIDUAIS ID
       LEFT JOIN PRODUTOS PO ON
         ( PO.CODIGO = ID.CODPRODUTO )
       LEFT JOIN TEMPITENS TI ON
         ( TI.CODMOVIMENTO = ID.CODMOVENTRADA AND
           TI.CODPRODUTO   = ID.CODPRODUTO    AND
           TI.CODIGO       = ID.CODITEM )
       LEFT JOIN OPERADORAS OP ON
         ( OP.CODIGO = ID.CODOPERADORA )
       LEFT JOIN PLANOS PL ON
         ( PL.CODIGO = ID.CODPLANO AND
           PL.CODOPERADORA = ID.CODOPERADORA )
     WHERE
       ID.CODMOVSAIDA = :CODMOVIMENTO AND
       ID.VENDIDO = 'S' AND
       ID.PS = 'P'
     GROUP BY
       ID.CODPRODUTO,
       ID.BARRA,
       PO.DESCRICAO,
       PO.UNIDADE,
       PO.CLASSFISCAL,
       PO.PESO,
       PO.CAIXA_ITENS,
       ID.SERIE,
       ID.SERIE2,
       ID.VALOR_VENDA,
       ID.ICMSVENDA,
       ID.DESCONTO,
       TI.SITTRIBU,
       TI.IPI,
       ID.NUMERO_FONE,
       ID.CONTRATO,
       ID.VOUCHER,
       ID.TIPOATIVACAO,
       ID.DESCONTO_ADM,
       OP.NOME,
       PL.NOME
     INTO
       :CODIGO,
       :BARRA,
       :DESCRICAO1,
       :UNIDADE,
       :CLASSFISCAL,
       :PESO,
       :CAIXA_ITENS,
       :SERIE,
       :SERIE2,
       :VALOR_VENDA,
       :ICMS_VENDA,
       :DESCONTO,
       :SITTRIBU,
       :IPI,
       :LINHA,
       :CONTRATO,
       :VOUCHER,
       :TIPOATIVACAO,
       :DESCONTO_ADM,
       :OPERADORA,
       :PLANO,
       :QUANTIDADE,
       :VALOR_PAGO,
       :VALOR_ICMS
     DO
     BEGIN

       /* VERIFICO SE O SERIE2 CONTEM DADOS E SERIE NAO, MANDO SERIE2 */
       IF ((UDF_TRIM(SERIE) = 'N/F') OR (UDF_TRIM(SERIE) = '')) THEN
         IF (UDF_TRIM(SERIE2) > '') THEN
           SERIE = SERIE2;

       IF (SERIE <> 'N/F') THEN
        BEGIN
          N = UDF_LEN(UDF_TRIM(DESCRICAO1));
          IF (N > 40) THEN
            DESCRICAO2 = UDF_COPY(DESCRICAO1, 1, 40) || ' ' || UDF_TRIM(SERIE);
          ELSE
            DESCRICAO2 = UDF_TRIM(DESCRICAO1) || ' ' || UDF_TRIM(SERIE);
        END ELSE
          DESCRICAO2 = DESCRICAO1;

       IF (CAIXA_ITENS IS NULL) THEN
         CAIXA_ITENS = 0;

       IF ((FATURA_CAIXAS = 'S') AND
          (QUANTIDADE >= CAIXA_ITENS)) THEN
        BEGIN
          UNIDADE = 'CX';
          QUANTIDADE = QUANTIDADE / CAIXA_ITENS;
          VALOR_VENDA = VALOR_VENDA * CAIXA_ITENS;
          DESCONTO = DESCONTO * CAIXA_ITENS;
        END

       VALOR_ITEM = VALOR_VENDA - DESCONTO;
       PESO = PESO * QUANTIDADE;

       IF (XIPI = 'N') THEN
        BEGIN
          IPI = NULL;
          VALOR_IPI = NULL;
        END ELSE
        BEGIN
          IF (IPI > 0) THEN
            VALOR_IPI = VALOR_PAGO * (IPI / 100);
          ELSE
            VALOR_IPI = 0;
        END

       SUSPEND;

     END
   END
END
^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE REL_NOTACORPO(
    CODMOVIMENTO INTEGER)
RETURNS (
    ES SMALLINT,
    CODCLIENTE INTEGER,
    DATA TIMESTAMP,
    SERVICOS VARCHAR(254),
    VALOR_SERVICOS NUMERIC(9,2),
    VALOR_ITENS NUMERIC(9,2),
    DESCONTO NUMERIC(9,2),
    VALOR_PRODUTOS NUMERIC(9,2),
    VALOR_ICMS NUMERIC(9,2),
    VALOR_TOTAL NUMERIC(9,2),
    OBSERVACOES VARCHAR(254),
    NOTA_NUMERO INTEGER,
    NOTA_DATAEMISSAO TIMESTAMP,
    NOTA_CODNATUOPER VARCHAR(10),
    NOTA_CODTRANSPORTADOR INTEGER,
    NOTA_PLACAVEICULO VARCHAR(10),
    NOTA_UFVEICULO VARCHAR(2),
    NOTA_FRETE SMALLINT,
    NOTA_VALOR_FRETE NUMERIC(9,2),
    NOTA_VALOR_SEGURO NUMERIC(9,2),
    NOTA_VALOR_OUTROS NUMERIC(9,2),
    NOTA_VALOR_TOTAL NUMERIC(9,2),
    NOTA_QUANTIDADE NUMERIC(9,2),
    NOTA_ESPECIE VARCHAR(30),
    NOTA_MARCA VARCHAR(20),
    NOTA_VOLNUM INTEGER,
    NOTA_PESOBRUTO NUMERIC(9,2),
    NOTA_PESOLIQUIDO NUMERIC(9,2),
    NOTA_DADOSADICIONAIS VARCHAR(254),
    CODVENDEDOR INTEGER,
    STATUS VARCHAR(30),
    CONDICAO VARCHAR(40),
    DATAINICIO TIMESTAMP,
    DATATERMINO TIMESTAMP,
    ICMSSIMPLES CHAR(1),
    ICMSSIMPALIQ NUMERIC(9,4),
    ISSALIQ NUMERIC(9,4),
    VALOR_ISS NUMERIC(9,2),
    NOTA_IESUBST VARCHAR(20),
    NOTA_DATASAIDA TIMESTAMP,
    NOTA_BASEICMS NUMERIC(9,4),
    NOTA_BASEICMSSUBST NUMERIC(9,4),
    NOTA_VALORICMSSUBST NUMERIC(9,2),
    VALOR_IPI NUMERIC(9,2),
    CODVENDEDOR_ABRE INTEGER,
    DESCONTOTXT VARCHAR(40),
    CLI_NOME VARCHAR(40),
    CLI_RAZAOSOCIAL VARCHAR(40),
    CLI_LOGRADOURO VARCHAR(60),
    CLI_NUMERO INTEGER,
    CLI_COMPLEMENTO VARCHAR(40),
    CLI_BAIRRO VARCHAR(60),
    CLI_CEP VARCHAR(10),
    CLI_CIDADE VARCHAR(60),
    CLI_ESTADO VARCHAR(2),
    CLI_FONE VARCHAR(20),
    CLI_FAX VARCHAR(20),
    CLI_CELULAR VARCHAR(20),
    CLI_EMAIL VARCHAR(50),
    CLI_RGIE VARCHAR(20),
    CLI_CPFCGC VARCHAR(20),
    TRA_NOME VARCHAR(40),
    TRA_LOGRADOURO VARCHAR(60),
    TRA_NUMERO INTEGER,
    TRA_COMPLEMENTO VARCHAR(40),
    TRA_BAIRRO VARCHAR(60),
    TRA_CEP VARCHAR(10),
    TRA_CIDADE VARCHAR(60),
    TRA_ESTADO VARCHAR(2),
    TRA_FONE VARCHAR(20),
    TRA_FAX VARCHAR(20),
    TRA_EMAIL VARCHAR(50),
    TRA_RGIE VARCHAR(20),
    TRA_CPFCGC VARCHAR(20),
    CODIGO INTEGER,
    MARCA VARCHAR(40),
    MODELO VARCHAR(40),
    DEFEITO VARCHAR(40),
    GARANTIA CHAR(1),
    SERIE VARCHAR(40),
    ACESSORIOS VARCHAR(50),
    CONDICAOEXTERNA VARCHAR(40),
    SOLICITANTE VARCHAR(40),
    VENDEDORABRE VARCHAR(40),
    VENDEDOR VARCHAR(40),
    USUARIO VARCHAR(40),
    CLI_CONTRATO CHAR(1),
    CLI_KM INTEGER,
    NATUREZAOPERACAO VARCHAR(30),
    CODEMPRESA INTEGER,
    EMPRESA_NOME VARCHAR(40),
    EMPRESA_RAZAOSOCIAL VARCHAR(50),
    EMPRESA_CNPJ VARCHAR(20),
    EMPRESA_IE VARCHAR(20),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO INTEGER,
    EMPRESA_COMPLEMENTO VARCHAR(40),
    EMPRESA_BAIRRO VARCHAR(60),
    EMPRESA_CIDADE VARCHAR(60),
    EMPRESA_ESTADO CHAR(2),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_FONE VARCHAR(20),
    TIPOOS VARCHAR(40),
    XX_ENTRADA CHAR(2),
    XX_SAIDA CHAR(2),
    EXTENSO VARCHAR(254),
    TECNICO VARCHAR(20),
    DEFEITO_DETECTADO VARCHAR(60),
    SERVICO_REALIZAR VARCHAR(60),
    AUTORIZADO CHAR(1),
    DATA_AUTORIZADO TIMESTAMP,
    QUEM_AUTORIZOU VARCHAR(40),
    DATA_ENTREGA TIMESTAMP,
    QUEM_ENTREGOU VARCHAR(40),
    QUEM_RECEBEU VARCHAR(40),
    NOTA_ENTRADA INTEGER,
    AUTORIZADO_SIM CHAR(1),
    AUTORIZADO_NAO CHAR(1),
    PARCEIRO VARCHAR(40),
    MENSAGEM_OS VARCHAR(254),
    MENSAGEM_VENDA VARCHAR(254),
    OPERADORA VARCHAR(40),
    NO_IPI CHAR(1),
    TOTAL_TRIBUTADO NUMERIC(14,3),
    TOTAL_CREDITOICMS NUMERIC(14,3),
    ALIQUOTA_ICMSSIMPLES NUMERIC(9,4))
AS
DECLARE VARIABLE TEMP_PESSOAFISICA CHAR(1);
DECLARE VARIABLE TEMP_RAZAOSOCIAL VARCHAR(40);
DECLARE VARIABLE TEMP_IE VARCHAR(20);
DECLARE VARIABLE TEMP_CGC VARCHAR(20);
DECLARE VARIABLE CODMARCA INTEGER;
DECLARE VARIABLE CODMODELO INTEGER;
DECLARE VARIABLE CODDEFEITO INTEGER;
DECLARE VARIABLE OSTIPO INTEGER;
DECLARE VARIABLE MAXTECNICO INTEGER;
DECLARE VARIABLE CODPARCEIRO INTEGER;
DECLARE VARIABLE SITUACAOTRIBUTARIA CHAR(3);
DECLARE VARIABLE VALORDOITEM NUMERIC(14,3);
BEGIN
  SELECT
    CODIGO,
    ES,
    CODCLIENTE,
    DATA,
    UDF_LEFT(SERVICOS, 254),
    VALOR_SERVICOS,
    VALOR_ITENS,
    DESCONTO,
    VALOR_PRODUTOS,
    VALOR_ICMS,
    VALOR_TOTAL,
    UDF_LEFT(OBSERVACOES, 254),
    NOTA_NUMERO,
    NOTA_DATAEMISSAO,
    NOTA_CODNATUOPER,
    NOTA_CODTRANSPORTADOR,
    NOTA_PLACAVEICULO,
    NOTA_UFVEICULO,
    NOTA_FRETE,
    NOTA_VALOR_FRETE,
    NOTA_VALOR_SEGURO,
    NOTA_VALOR_OUTROS,
    NOTA_VALOR_TOTAL,
    NOTA_QUANTIDADE,
    NOTA_ESPECIE,
    NOTA_MARCA,
    NOTA_VOLNUM,
    NOTA_PESOBRUTO,
    NOTA_PESOLIQUIDO,
    UDF_LEFT(NOTA_DADOSADICIONAIS, 254),
    CODVENDEDOR,
    STATUS,
    CONDICAO,
    DATAINICIO,
    DATATERMINO,
    ICMSSIMPLES,
    ICMSSIMPALIQ,
    ISSALIQ,
    VALOR_ISS,
    NOTA_IESUBST,
    NOTA_DATASAIDA,
    NOTA_BASEICMS,
    NOTA_BASEICMSSUBST,
    NOTA_VALORICMSSUBST,
    VALOR_IPI,
    CODVENDEDOR_ABRE,
    DESCONTOTXT,
    CODMARCA,
    CODMODELO,
    CODDEFEITO,
    GARANTIA,
    SERIE,
    ACESSORIOS,
    CONDICAOEXTERNA,
    SOLICITANTE,
    CODEMPRESA,
    OSTIPO,
    DEFEITO_DETECTADO,
    SERVICO_REALIZAR,
    AUTORIZADO,
    DATA_AUTORIZADO,
    QUEM_AUTORIZOU,
    DATA_ENTREGA,
    QUEM_ENTREGOU,
    QUEM_RECEBEU,
    NOTA_ENTRADA,
    CODPARCEIRO,
    OPERADORA,
    NO_IPI
  FROM
    MOVIMENTOS MO
  WHERE
    CODIGO = :CODMOVIMENTO
  INTO
    :CODIGO,
    :ES,
    :CODCLIENTE,
    :DATA,
    :SERVICOS,
    :VALOR_SERVICOS,
    :VALOR_ITENS,
    :DESCONTO,
    :VALOR_PRODUTOS,
    :VALOR_ICMS,
    :VALOR_TOTAL,
    :OBSERVACOES,
    :NOTA_NUMERO,
    :NOTA_DATAEMISSAO,
    :NOTA_CODNATUOPER,
    :NOTA_CODTRANSPORTADOR,
    :NOTA_PLACAVEICULO,
    :NOTA_UFVEICULO,
    :NOTA_FRETE,
    :NOTA_VALOR_FRETE,
    :NOTA_VALOR_SEGURO,
    :NOTA_VALOR_OUTROS,
    :NOTA_VALOR_TOTAL,
    :NOTA_QUANTIDADE,
    :NOTA_ESPECIE,
    :NOTA_MARCA,
    :NOTA_VOLNUM,
    :NOTA_PESOBRUTO,
    :NOTA_PESOLIQUIDO,
    :NOTA_DADOSADICIONAIS,
    :CODVENDEDOR,
    :STATUS,
    :CONDICAO,
    :DATAINICIO,
    :DATATERMINO,
    :ICMSSIMPLES,
    :ICMSSIMPALIQ,
    :ISSALIQ,
    :VALOR_ISS,
    :NOTA_IESUBST,
    :NOTA_DATASAIDA,
    :NOTA_BASEICMS,
    :NOTA_BASEICMSSUBST,
    :NOTA_VALORICMSSUBST,
    :VALOR_IPI,
    :CODVENDEDOR_ABRE,
    :DESCONTOTXT,
    :CODMARCA,
    :CODMODELO,
    :CODDEFEITO,
    :GARANTIA,
    :SERIE,
    :ACESSORIOS,
    :CONDICAOEXTERNA,
    :SOLICITANTE,
    :CODEMPRESA,
    :OSTIPO,
    :DEFEITO_DETECTADO,
    :SERVICO_REALIZAR,
    :AUTORIZADO,
    :DATA_AUTORIZADO,
    :QUEM_AUTORIZOU,
    :DATA_ENTREGA,
    :QUEM_ENTREGOU,
    :QUEM_RECEBEU,
    :NOTA_ENTRADA,
    :CODPARCEIRO,
    :OPERADORA,
    :NO_IPI;

  SELECT
    CL.NOME,
    UDF_LEFT(CL.RAZAOSOCIAL, 40),
    CL.PESSOAFISICA,
    CL.NUMERO,
    CL.COMPLEMENTO,
    CL.ESTADO,
    CL.FONE,
    CL.FAX,
    CL.CELULAR,
    CL.EMAIL,
    CL.RG,
    CL.CPF,
    CL.IE,
    CL.CGC,
    CL.CONTRATO,
    CL.KMS,
    LO.LOGRADOURO,
    BA.BAIRRO,
    CI.CIDADE,
    LO.CEP
  FROM
    CLIENTES CL
    LEFT JOIN LOGRADOUROS LO ON
      ( LO.CODIGO = CL.LOCALIZACAO AND
        LO.BAIRRO = CL.BAIRRO AND
        LO.CIDADE = CL.CIDADE AND
        LO.ESTADO = CL.ESTADO )
    LEFT JOIN BAIRROS BA ON
      ( BA.CODIGO = CL.BAIRRO AND
        BA.CIDADE = CL.CIDADE AND
        BA.ESTADO = CL.ESTADO )
    LEFT JOIN CIDADES CI ON
      ( CI.CODIGO = CL.CIDADE AND
        CI.ESTADO = CL.ESTADO )
  WHERE
    CL.CODIGO = :CODCLIENTE
  INTO
    :CLI_NOME,
    :TEMP_RAZAOSOCIAL,
    :TEMP_PESSOAFISICA,
    :CLI_NUMERO,
    :CLI_COMPLEMENTO,
    :CLI_ESTADO,
    :CLI_FONE,
    :CLI_FAX,
    :CLI_CELULAR,
    :CLI_EMAIL,
    :CLI_RGIE,
    :CLI_CPFCGC,
    :TEMP_IE,
    :TEMP_CGC,
    :CLI_CONTRATO,
    :CLI_KM,
    :CLI_LOGRADOURO,
    :CLI_BAIRRO,
    :CLI_CIDADE,
    :CLI_CEP;

  IF ( TEMP_PESSOAFISICA = 'J' ) THEN
   BEGIN
     CLI_RGIE        = TEMP_IE;
     CLI_CPFCGC      = TEMP_CGC;
     CLI_RAZAOSOCIAL = TEMP_RAZAOSOCIAL;
   END ELSE CLI_RAZAOSOCIAL = CLI_NOME;

  TEMP_PESSOAFISICA = '';
  TEMP_IE           = '';
  TEMP_CGC          = '';
  TEMP_RAZAOSOCIAL  = '';

  SELECT
    TR.NOME,
    UDF_LEFT(TR.RAZAOSOCIAL, 40),
    TR.PESSOAFISICA,
    TR.NUMERO,
    TR.COMPLEMENTO,
    TR.ESTADO,
    TR.FONE,
    TR.FAX,
    TR.EMAIL,
    TR.RG,
    TR.CPF,
    TR.IE,
    TR.CGC,
    LO.LOGRADOURO,
    BA.BAIRRO,
    CI.CIDADE,
    LO.CEP
  FROM
    CLIENTES TR
    LEFT JOIN LOGRADOUROS LO ON
      ( LO.CODIGO = TR.LOCALIZACAO AND
        LO.BAIRRO = TR.BAIRRO AND
        LO.CIDADE = TR.CIDADE AND
        LO.ESTADO = TR.ESTADO )
    LEFT JOIN BAIRROS BA ON
      ( BA.CODIGO = TR.BAIRRO AND
        BA.CIDADE = TR.CIDADE AND
        BA.ESTADO = TR.ESTADO )
    LEFT JOIN CIDADES CI ON
      ( CI.CODIGO = TR.CIDADE AND
        CI.ESTADO = TR.ESTADO )
  WHERE
    TR.CODIGO = :NOTA_CODTRANSPORTADOR
  INTO
    :TRA_NOME,
    :TEMP_RAZAOSOCIAL,
    :TEMP_PESSOAFISICA,
    :TRA_NUMERO,
    :TRA_COMPLEMENTO,
    :TRA_ESTADO,
    :TRA_FONE,
    :TRA_FAX,
    :TRA_EMAIL,
    :TRA_RGIE,
    :TRA_CPFCGC,
    :TEMP_IE,
    :TEMP_CGC,
    :TRA_LOGRADOURO,
    :TRA_BAIRRO,
    :TRA_CIDADE,
    :TRA_CEP;

  IF ( TEMP_PESSOAFISICA = 'J' ) THEN
   BEGIN
     TRA_RGIE   = TEMP_IE;
     TRA_CPFCGC = TEMP_CGC;
   END

  SELECT
    NOME
  FROM
    CLIENTES
  WHERE
    CODIGO = :CODVENDEDOR_ABRE
  INTO
    :VENDEDORABRE;

  SELECT
    NOME
  FROM
    CLIENTES
  WHERE
    CODIGO = :CODVENDEDOR
  INTO
    :VENDEDOR;

  SELECT
    DESCRICAO
  FROM
    MARCAS
  WHERE
    CODIGO = :CODMARCA
  INTO
    :MARCA;

  SELECT
    DESCRICAO
  FROM
    MODELOS
  WHERE
    CODIGO = :CODMODELO AND
    CODEQUIPAMENTO = :CODMARCA
  INTO
    :MODELO;

  SELECT
    DESCRICAO
  FROM
    DEFEITOS
  WHERE
    CODIGO = :CODDEFEITO
  INTO
    :DEFEITO;

  SELECT
    NATUREZA
  FROM
    NATUOPER
  WHERE
    CODIGO = :NOTA_CODNATUOPER
  INTO
    :NATUREZAOPERACAO;

  SELECT
    TIPO
  FROM
    OSTIPOS
  WHERE
    CODIGO = :OSTIPO
  INTO
    :TIPOOS;

  SELECT
    CL.NOME,
    CL.RAZAOSOCIAL,
    CL.CGC,
    CL.IE,
    CL.LOGRADOURO,
    CL.NUMERO,
    CL.COMPLEMENTO,
    CL.BAIRRO,
    CL.CIDADE,
    CL.ESTADO,
    CL.CEP,
    CL.FONE,
    SI.MENSAGEM_OS,
    SI.MENSAGEM_VENDA,
    SI.ALIQUOTA_ICMSSIMPLES
  FROM
    SISCONFIG SI
    JOIN REL_CLIENTES CL ON
      (SI.CODCLIENTE = CL.CODIGO)
  WHERE
    SI.CODIGO = :CODEMPRESA
  INTO
    :EMPRESA_NOME,
    :EMPRESA_RAZAOSOCIAL,
    :EMPRESA_CNPJ,
    :EMPRESA_IE,
    :EMPRESA_LOGRADOURO,
    :EMPRESA_NUMERO,
    :EMPRESA_COMPLEMENTO,
    :EMPRESA_BAIRRO,
    :EMPRESA_CIDADE,
    :EMPRESA_ESTADO,
    :EMPRESA_CEP,
    :EMPRESA_FONE,
    :MENSAGEM_OS,
    :MENSAGEM_VENDA,
    :ALIQUOTA_ICMSSIMPLES;

  USUARIO = USER;

  IF (ES = 1) THEN
   BEGIN

     XX_ENTRADA = 'XX';
     XX_SAIDA   = '  ';

   END ELSE
   BEGIN

     XX_ENTRADA = '  ';
     XX_SAIDA   = 'XX';

   END

  SELECT
    EXTENSO
  FROM
    MOEDAEXTENSO(
       CAST(:NOTA_VALOR_TOTAL AS DOUBLE PRECISION),
       :CODEMPRESA
    )
  INTO
    :EXTENSO;

 SELECT
   MIN(OS.CODVENDEDOR)
 FROM
   OS_VENDER OS
 WHERE
   OS.CODMOVIMENTO = :CODMOVIMENTO
 INTO
   :MAXTECNICO;

 SELECT
   UDF_LEFT(CL.NOME, 20)
 FROM
   CLIENTES CL
 WHERE
   CL.CODIGO = :MAXTECNICO
 INTO
   :TECNICO;

 AUTORIZADO_SIM = ' ';
 AUTORIZADO_NAO = ' ';

 IF (DATA_AUTORIZADO IS NOT NULL) THEN
  BEGIN
    IF (AUTORIZADO = 'S') THEN
      AUTORIZADO_SIM = 'X';
    ELSE
      AUTORIZADO_NAO = 'X';
  END

 SELECT
   NOME
 FROM
   CLIENTES
 WHERE
   CODIGO = :CODPARCEIRO
 INTO
   :PARCEIRO;

 IF (NO_IPI = 'S') THEN
  BEGIN

    SELECT
      SUM(VALOR_IPI)
    FROM
      REL_NOTAPRO(:CODMOVIMENTO)
    INTO
      :VALOR_IPI;

    IF (VALOR_IPI IS NULL) THEN
      VALOR_IPI = 0;

    NOTA_VALOR_TOTAL = NOTA_VALOR_TOTAL + VALOR_IPI;

  END

  /* TOTAL A SER TRIBUTADO */
  TOTAL_TRIBUTADO = 0;
  FOR
  SELECT
    SITTRIBU,
    VALOR_PAGO
  FROM
    REL_NOTAPRO(:CODMOVIMENTO)
  INTO
    :SITUACAOTRIBUTARIA,
    :VALORDOITEM
  DO
  BEGIN
    IF ((SITUACAOTRIBUTARIA = '060') OR (SITUACAOTRIBUTARIA = '160') OR (SITUACAOTRIBUTARIA = '260')) THEN
      TOTAL_TRIBUTADO = TOTAL_TRIBUTADO + VALORDOITEM;
  END
  TOTAL_CREDITOICMS = TOTAL_TRIBUTADO * (ALIQUOTA_ICMSSIMPLES / 100);

 SUSPEND;
END

^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE REL_NOTAITENS(
    CODMOVIMENTO INTEGER)
RETURNS (
    CODIGO INTEGER,
    BARRA CHAR(13),
    DESCRICAO1 VARCHAR(60),
    DESCRICAO2 VARCHAR(80),
    SERIE VARCHAR(20),
    SERIE2 VARCHAR(20),
    VALOR_VENDA NUMERIC(14,3),
    ICMS_VENDA NUMERIC(14,4),
    DESCONTO NUMERIC(14,3),
    QUANTIDADE NUMERIC(14,3),
    VALOR_PAGO NUMERIC(14,3),
    VALOR_ICMS NUMERIC(14,3),
    SITTRIBU CHAR(3),
    UNIDADE CHAR(2),
    VALOR_ITEM NUMERIC(14,3),
    IPI NUMERIC(14,4),
    LINHA VARCHAR(20),
    OPERADORA VARCHAR(40),
    PLANO VARCHAR(40),
    ATIVACAO CHAR(1),
    CONTRATO VARCHAR(10),
    VOUCHER VARCHAR(10),
    TIPOATIVACAO CHAR(1),
    VALOR_CUSTO NUMERIC(14,3),
    CLASSFISCAL VARCHAR(20),
    PESO NUMERIC(9,3))
AS
DECLARE VARIABLE ESMOV INTEGER;
DECLARE VARIABLE TIPOMOV INTEGER;
BEGIN

  SELECT
    ES,
    TIPO
  FROM
    MOVIMENTOS
  WHERE
    CODIGO = :CODMOVIMENTO
  INTO
    :ESMOV,
    :TIPOMOV;

  IF ((TIPOMOV = 9) OR ((ESMOV = 0) AND (TIPOMOV = 1))) THEN
   BEGIN

     /* ITENS ESTORNADOS OU DE ORÇAMENTO */
     FOR
     SELECT
       TI.CODPRODUTO,
       PO.BARRA,
       PO.DESCRICAO,
       PO.DESCRICAO,
       TI.SERIE,
       TI.SERIE2,
       TI.VALOR_UNITARIO,
       TI.ICMSVENDA,
       TI.DESCONTO,
       TI.QUANTIDADE,
       TI.VALOR_TOTAL,
       TI.VALOR_ICMSCOMPRA,
       TI.SITTRIBU,
       PO.UNIDADE,
       PO.ATIVACAO,
       (TI.VALOR_UNITARIO - TI.DESCONTO),
       TI.IPI,
       PO.PRECOCUSTO,
       PO.PESO
     FROM
       TEMPITENS TI
       JOIN PRODUTOS PO ON
        (PO.CODIGO = TI.CODPRODUTO)
     WHERE
       CODMOVIMENTO = :CODMOVIMENTO
     INTO
       :CODIGO,
       :BARRA,
       :DESCRICAO1,
       :DESCRICAO2,
       :SERIE,
       :SERIE2,
       :VALOR_VENDA,
       :ICMS_VENDA,
       :DESCONTO,
       :QUANTIDADE,
       :VALOR_PAGO,
       :VALOR_ICMS,
       :SITTRIBU,
       :UNIDADE,
       :ATIVACAO,
       :VALOR_ITEM,
       :IPI,
       :VALOR_CUSTO,
       :PESO
     DO
     BEGIN

       /* TRATAMENTO DA SERIE */
       IF ((UDF_TRIM(SERIE) <> 'N/F') AND (UDF_TRIM(SERIE) > '')) THEN
        BEGIN
          DESCRICAO2 = UDF_TRIM(DESCRICAO1) || ' ' || UDF_TRIM(SERIE);
        END ELSE
        BEGIN
          IF (UDF_TRIM(SERIE2) > '') THEN
           BEGIN
             DESCRICAO2 = UDF_TRIM(DESCRICAO1) || ' ' || UDF_TRIM(SERIE2);
           END ELSE
             DESCRICAO2 = UDF_TRIM(DESCRICAO1);
        END

       PESO = PESO * QUANTIDADE;

       LINHA = NULL;
       OPERADORA = NULL;
       PLANO = NULL;
       CONTRATO = NULL;
       VOUCHER = NULL;
       TIPOATIVACAO = NULL;
       CLASSFISCAL = NULL;

       SUSPEND;

     END

   END ELSE
   BEGIN

     /* PRODUTOS */
     FOR
     SELECT
       CODIGO,
       BARRA,
       DESCRICAO1,
       DESCRICAO2,
       SERIE,
       SERIE2,
       VALOR_VENDA,
       ICMS_VENDA,
       DESCONTO,
       QUANTIDADE,
       VALOR_PAGO,
       VALOR_ICMS,
       SITTRIBU,
       UNIDADE,
       VALOR_ITEM,
       IPI,
       LINHA,
       OPERADORA,
       PLANO,
       'N',
       CONTRATO,
       VOUCHER,
       TIPOATIVACAO,
       CLASSFISCAL,
       PESO
     FROM
       REL_NOTAPRO(:CODMOVIMENTO)
     INTO
       :CODIGO,
       :BARRA,
       :DESCRICAO1,
       :DESCRICAO2,
       :SERIE,
       :SERIE2,
       :VALOR_VENDA,
       :ICMS_VENDA,
       :DESCONTO,
       :QUANTIDADE,
       :VALOR_PAGO,
       :VALOR_ICMS,
       :SITTRIBU,
       :UNIDADE,
       :VALOR_ITEM,
       :IPI,
       :LINHA,
       :OPERADORA,
       :PLANO,
       :ATIVACAO,
       :CONTRATO,
       :VOUCHER,
       :TIPOATIVACAO,
       :CLASSFISCAL,
       :PESO
     DO
     BEGIN

       VALOR_CUSTO = 0;
       SUSPEND;

     END

     /* SERVIÇOS */
     FOR
     SELECT
       CODIGO,
       BARRA,
       DESCRICAO1,
       DESCRICAO2,
       SERIE,
       SERIE2,
       VALOR_VENDA,
       ICMS_VENDA,
       DESCONTO,
       QUANTIDADE,
       VALOR_PAGO,
       VALOR_ICMS,
       SITTRIBU,
       'SE',
       VALOR_ITEM,
       0 AS IPI,
       ATIVACAO
     FROM
       REL_NOTASER(:CODMOVIMENTO)
     INTO
       :CODIGO,
       :BARRA,
       :DESCRICAO1,
       :DESCRICAO2,
       :SERIE,
       :SERIE2,
       :VALOR_VENDA,
       :ICMS_VENDA,
       :DESCONTO,
       :QUANTIDADE,
       :VALOR_PAGO,
       :VALOR_ICMS,
       :SITTRIBU,
       :UNIDADE,
       :VALOR_ITEM,
       :IPI,
       :ATIVACAO
     DO
     BEGIN

       PESO = 0;
       LINHA = NULL;
       OPERADORA = NULL;
       PLANO = NULL;
       CONTRATO = NULL;
       VOUCHER = NULL;
       TIPOATIVACAO = NULL;
       VALOR_CUSTO = 0;
       CLASSFISCAL = NULL;
       SUSPEND;

     END

   END
END

^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE REL_NOTAITENS (
    CODMOVIMENTO INTEGER)
RETURNS (
    CODIGO INTEGER,
    BARRA CHAR(13),
    DESCRICAO1 VARCHAR(60),
    DESCRICAO2 VARCHAR(80),
    SERIE VARCHAR(20),
    SERIE2 VARCHAR(20),
    VALOR_VENDA NUMERIC(14,3),
    ICMS_VENDA NUMERIC(14,4),
    DESCONTO NUMERIC(14,3),
    QUANTIDADE NUMERIC(14,3),
    VALOR_PAGO NUMERIC(14,3),
    VALOR_ICMS NUMERIC(14,3),
    SITTRIBU CHAR(3),
    UNIDADE CHAR(2),
    VALOR_ITEM NUMERIC(14,3),
    IPI NUMERIC(14,4),
    LINHA VARCHAR(20),
    OPERADORA VARCHAR(40),
    PLANO VARCHAR(40),
    ATIVACAO CHAR(1),
    CONTRATO VARCHAR(10),
    VOUCHER VARCHAR(10),
    TIPOATIVACAO CHAR(1),
    VALOR_CUSTO NUMERIC(14,3),
    CLASSFISCAL VARCHAR(20),
    PESO NUMERIC(9,3),
    DESCONTO_ADM NUMERIC(9,2))
AS
DECLARE VARIABLE ESMOV INTEGER;
DECLARE VARIABLE TIPOMOV INTEGER;
BEGIN

  SELECT
    ES,
    TIPO
  FROM
    MOVIMENTOS
  WHERE
    CODIGO = :CODMOVIMENTO
  INTO
    :ESMOV,
    :TIPOMOV;

  IF ((TIPOMOV = 9) OR ((ESMOV = 0) AND (TIPOMOV = 1))) THEN
   BEGIN

     /* ITENS ESTORNADOS OU DE ORÇAMENTO */
     FOR
     SELECT
       TI.CODPRODUTO,
       PO.BARRA,
       PO.DESCRICAO,
       PO.DESCRICAO,
       TI.SERIE,
       TI.SERIE2,
       TI.VALOR_UNITARIO,
       TI.ICMSVENDA,
       TI.DESCONTO,
       TI.QUANTIDADE,
       TI.VALOR_TOTAL,
       TI.VALOR_ICMSCOMPRA,
       TI.SITTRIBU,
       PO.UNIDADE,
       PO.ATIVACAO,
       (TI.VALOR_UNITARIO - TI.DESCONTO),
       TI.IPI,
       PO.PRECOCUSTO,
       PO.PESO
     FROM
       TEMPITENS TI
       JOIN PRODUTOS PO ON
        (PO.CODIGO = TI.CODPRODUTO)
     WHERE
       CODMOVIMENTO = :CODMOVIMENTO
     INTO
       :CODIGO,
       :BARRA,
       :DESCRICAO1,
       :DESCRICAO2,
       :SERIE,
       :SERIE2,
       :VALOR_VENDA,
       :ICMS_VENDA,
       :DESCONTO,
       :QUANTIDADE,
       :VALOR_PAGO,
       :VALOR_ICMS,
       :SITTRIBU,
       :UNIDADE,
       :ATIVACAO,
       :VALOR_ITEM,
       :IPI,
       :VALOR_CUSTO,
       :PESO
     DO
     BEGIN

       /* TRATAMENTO DA SERIE */
       IF ((UDF_TRIM(SERIE) <> 'N/F') AND (UDF_TRIM(SERIE) > '')) THEN
        BEGIN
          DESCRICAO2 = UDF_TRIM(DESCRICAO1) || ' ' || UDF_TRIM(SERIE);
        END ELSE
        BEGIN
          IF (UDF_TRIM(SERIE2) > '') THEN
           BEGIN
             DESCRICAO2 = UDF_TRIM(DESCRICAO1) || ' ' || UDF_TRIM(SERIE2);
           END ELSE
             DESCRICAO2 = UDF_TRIM(DESCRICAO1);
        END

       PESO = PESO * QUANTIDADE;

       LINHA = NULL;
       OPERADORA = NULL;
       PLANO = NULL;
       CONTRATO = NULL;
       VOUCHER = NULL;
       TIPOATIVACAO = NULL;
       CLASSFISCAL = NULL;

       SUSPEND;

     END

   END ELSE
   BEGIN

     /* PRODUTOS */
     FOR
     SELECT
       CODIGO,
       BARRA,
       DESCRICAO1,
       DESCRICAO2,
       SERIE,
       SERIE2,
       VALOR_VENDA,
       ICMS_VENDA,
       DESCONTO,
       QUANTIDADE,
       VALOR_PAGO,
       VALOR_ICMS,
       SITTRIBU,
       UNIDADE,
       VALOR_ITEM,
       IPI,
       LINHA,
       OPERADORA,
       PLANO,
       'N',
       CONTRATO,
       VOUCHER,
       TIPOATIVACAO,
       DESCONTO_ADM,
       CLASSFISCAL,
       PESO
     FROM
       REL_NOTAPRO(:CODMOVIMENTO)
     INTO
       :CODIGO,
       :BARRA,
       :DESCRICAO1,
       :DESCRICAO2,
       :SERIE,
       :SERIE2,
       :VALOR_VENDA,
       :ICMS_VENDA,
       :DESCONTO,
       :QUANTIDADE,
       :VALOR_PAGO,
       :VALOR_ICMS,
       :SITTRIBU,
       :UNIDADE,
       :VALOR_ITEM,
       :IPI,
       :LINHA,
       :OPERADORA,
       :PLANO,
       :ATIVACAO,
       :CONTRATO,
       :VOUCHER,
       :TIPOATIVACAO,
       :DESCONTO_ADM,
       :CLASSFISCAL,
       :PESO
     DO
     BEGIN

       VALOR_CUSTO = 0;
       SUSPEND;

     END

     /* SERVIÇOS */
     FOR
     SELECT
       CODIGO,
       BARRA,
       DESCRICAO1,
       DESCRICAO2,
       SERIE,
       SERIE2,
       VALOR_VENDA,
       ICMS_VENDA,
       DESCONTO,
       QUANTIDADE,
       VALOR_PAGO,
       VALOR_ICMS,
       SITTRIBU,
       'SE',
       VALOR_ITEM,
       0 AS IPI,
       ATIVACAO
     FROM
       REL_NOTASER(:CODMOVIMENTO)
     INTO
       :CODIGO,
       :BARRA,
       :DESCRICAO1,
       :DESCRICAO2,
       :SERIE,
       :SERIE2,
       :VALOR_VENDA,
       :ICMS_VENDA,
       :DESCONTO,
       :QUANTIDADE,
       :VALOR_PAGO,
       :VALOR_ICMS,
       :SITTRIBU,
       :UNIDADE,
       :VALOR_ITEM,
       :IPI,
       :ATIVACAO
     DO
     BEGIN

       PESO = 0;
       LINHA = NULL;
       OPERADORA = NULL;
       PLANO = NULL;
       CONTRATO = NULL;
       VOUCHER = NULL;
       TIPOATIVACAO = NULL;
       DESCONTO_ADM = 0;
       VALOR_CUSTO = 0;
       CLASSFISCAL = NULL;
       SUSPEND;

     END

   END
END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (445, CURRENT_TIMESTAMP);
COMMIT;
